name: Build Installer
on:
  workflow_call:
    inputs:
      jar_cache_key:
        required: true
        type: string
      release_tag:
        required: false
        type: string
        default: "main"
      setup_script:
        required: true
        type: string
      app_name:
        required: true
        type: string
      app_version:
        required: true
        type: string
      output_name:
        required: true
        type: string

jobs:
  build-installer:
    runs-on: windows-latest
    env:
      APP_NAME: ${{ inputs.app_name }}
      APP_VERSION: ${{ inputs.app_version }}
      OUTPUT_NAME: ${{ inputs.output_name }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag }}
          
      - name: Restore cached JAR
        uses: actions/cache/restore@v3
        with:
          path: build/libs/*.jar
          key: ${{ inputs.jar_cache_key }}
          
      - name: Check JAR presence
        run: |
          if (!(Test-Path "build\libs\*.jar")) {
            Write-Error "JAR file not found after cache restore."
            exit 1
          }
          
      - name: Get JAR filename
        id: jar-name
        run: |
          $jar = Get-ChildItem build\libs\*.jar | Select-Object -First 1
          if (!$jar) {
            Write-Error "No JAR file found!"
            exit 1
          }
          echo "jar_file=$($jar.Name)" >> $env:GITHUB_OUTPUT
          echo "Found JAR: $($jar.Name)"
      
         
      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y
        
      - name: Validate Inno Setup install
        run: |
          if (!(Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe")) {
            Write-Error "Inno Setup not installed correctly."
            exit 1
          }
          
      - name: Build setup.exe with Inno Setup
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DAppName="${{ inputs.app_name }}" `
            /DAppVersion="${{ inputs.app_version }}" `
            /DJarFileName="${{ steps.jar-name.outputs.jar_file }}" `
            /DOutputBaseName="${{ inputs.output_name }}" `
            "${{ inputs.setup_script }}" | Tee-Object -FilePath build-log.txt
                  
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: setup-installer
          path: output/${{ inputs.output_name }}
          
      - name: Installer Build Complete
        run: echo "âœ… Installer successfully built and uploaded."
