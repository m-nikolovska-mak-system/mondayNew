name: Build Installer

on:
  workflow_call:
    inputs:
      jar_cache_key:
        required: true
        type: string
      release_tag:
        required: true
        type: string
      app_name:
        required: true
        type: string
      app_version:
        required: true
        type: string
      jar_name:
        required: true
        type: string
      output_name:
        required: true
        type: string

jobs:
  build-installer:
    runs-on: windows-latest
    env:
      APP_NAME: ${{ inputs.app_name }}
      APP_VERSION: ${{ inputs.app_version }}
      JAR_NAME: ${{ inputs.jar_name }}
      OUTPUT_NAME: ${{ inputs.output_name }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag }}

      - name: Restore cached JAR
        uses: actions/cache/restore@v3
        with:
          path: build/libs/*.jar
          key: ${{ inputs.jar_cache_key }}

      - name: Check JAR presence
        run: |
          if (!(Test-Path "build\libs\*.jar")) {
            Write-Error "JAR file not found after cache restore."
            exit 1
          }

      - name: Rename JAR to standardized name
        run: |
          $jar = Get-ChildItem build\libs\*.jar | Select-Object -First 1
          Rename-Item $jar.FullName -NewName $env:JAR_NAME -Force

      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y

      - name: Validate Inno Setup install
        run: |
          if (!(Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe")) {
            Write-Error "Inno Setup not installed correctly."
            exit 1
          }

      - name: Build setup.exe with Inno Setup
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup-script.iss | Tee-Object -FilePath build-log.txt

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: setup-installer
          path: output/${{ inputs.output_name }}

      - name: Installer Build Complete
        run: echo "âœ… Installer successfully built and uploaded."
