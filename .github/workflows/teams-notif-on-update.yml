name: App Source Change to Notify Teams
on:
  push:
    paths:
      - '**/src/**/com/miha/app/**'
  workflow_dispatch:

jobs:
  notify-teams:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changes
        run: |
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            CHANGED=$(git ls-tree -r --name-only ${GITHUB_SHA})
          else
            git fetch --no-tags --prune origin +refs/heads/*:refs/remotes/origin/* || true
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
    
      - name: Send Microsoft Teams notification
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_INSTALLER_URL }}
        run: |
          FILES="${{ steps.changes.outputs.files }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          SHA="${{ github.sha }}"
          DISPLAY_ACTOR=${ACTOR:-"Unknown user"}
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          
          # Create MessageCard payload
          PAYLOAD=$(cat <<EOF
          {
            "@type": "MessageCard",
            "@context": "https://schema.org/extensions",
            "summary": "App Source Files Updated",
            "themeColor": "0076D7",
            "title": "ðŸš€ App Source Files Updated",
            "sections": [
              {
                "facts": [
                  {
                    "name": "ðŸ‘¤ Pushed by:",
                    "value": "[${DISPLAY_ACTOR}](https://github.com/${ACTOR})"
                  },
                  {
                    "name": "ðŸ”— Commit:",
                    "value": "[View Commit](https://github.com/${REPO}/commit/${SHA})"
                  },
                  {
                    "name": "ðŸ•’ Timestamp:",
                    "value": "${TIMESTAMP}"
                  }
                ],
                "text": "**ðŸ“‚ Files Changed:**\n\n\`\`\`\n${FILES}\n\`\`\`"
              }
            ]
          }
          EOF
          )
          
          echo "Sending message to Teams..."
          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$TEAMS_WEBHOOK_URL"
