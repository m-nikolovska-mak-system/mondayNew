name: App Source Change to Notify Teams
on:
  push:
    paths:
      - '**/src/**/com/miha/app/**'
  workflow_dispatch:

jobs:
  notify-teams:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changes
        run: |
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            CHANGED=$(git ls-tree -r --name-only ${GITHUB_SHA})
          else
            git fetch --no-tags --prune origin +refs/heads/*:refs/remotes/origin/* || true
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
    
      - name: Send Microsoft Teams notification
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_INSTALLER_URL }}
        run: |
          FILES="${{ steps.changes.outputs.files }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          DISPLAY_ACTOR=${ACTOR:-"Unknown user"}
          TIMESTAMP=$(TZ='Europe/Belgrade' date +"%Y-%m-%d %H:%M %Z")
          
          # Escape newlines for JSON
          FILES_ESCAPED=$(echo "$FILES" | sed 's/$/\\n/' | tr -d '\n')
          
          # Create Adaptive Card payload
          PAYLOAD=$(cat <<EOF
          {
            "type": "message",
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "content": {
                  "type": "AdaptiveCard",
                  "version": "1.4",
                  "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "body": [
                    {
                      "type": "ColumnSet",
                      "columns": [
                        {
                          "type": "Column",
                          "width": "auto",
                          "items": [
                            {
                              "type": "Image",
                              "url": "https://github.com/${ACTOR}.png",
                              "size": "Small",
                              "style": "Person"
                            }
                          ]
                        },
                        {
                          "type": "Column",
                          "width": "stretch",
                          "items": [
                            {
                              "type": "TextBlock",
                              "text": "🚀 App Source Files Updated",
                              "weight": "Bolder",
                              "size": "Large",
                              "color": "Accent"
                            },
                            {
                              "type": "TextBlock",
                              "text": "${DISPLAY_ACTOR} pushed to ${REPO}",
                              "spacing": "None",
                              "isSubtle": true
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "Container",
                      "style": "attention",
                      "items": [
                        {
                          "type": "TextBlock",
                          "text": "⚠️ **Action Required:** New installer needs to be prepared for Template Designer",
                          "wrap": true,
                          "weight": "Bolder"
                        }
                      ]
                    },
                    {
                      "type": "TextBlock",
                      "text": "🔗 **Commit:** [${SHORT_SHA}](https://github.com/${REPO}/commit/${SHA})",
                      "wrap": true
                    },
                    {
                      "type": "TextBlock",
                      "text": "🕒 **Timestamp:** ${TIMESTAMP}",
                      "wrap": true,
                      "spacing": "Small"
                    },
                    {
                      "type": "TextBlock",
                      "text": "📂 **Files Changed:**",
                      "weight": "Bolder"
                    },
                    {
                      "type": "TextBlock",
                      "text": "${FILES}",
                      "fontType": "Monospace",
                      "wrap": true
                    }
                  ],
                  "actions": [
                    {
                      "type": "Action.OpenUrl",
                      "title": "View Commit",
                      "url": "https://github.com/${REPO}/commit/${SHA}"
                    }
                  ]
                }
              }
            ]
          }
          EOF
          )
          
          echo "Sending message to Teams..."
          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$TEAMS_WEBHOOK_URL"
