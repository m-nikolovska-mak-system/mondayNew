name: Build & Release Java App

on:
  release:
    types: [created]

jobs:

  build_jar:
    name: Build JAR
    uses: m-nikolovska-mak-system/reusable-actions-library/.github/workflows/build-jar.yml@main
    with:
      release_tag: ${{ github.event.release.tag_name }}
      gradle_task: jar
      java_version: '17'
      java_distribution: 'temurin'

  detect_iss:
    name: Detect Setup Script
    uses: m-nikolovska-mak-system/reusable-actions-library/.github/workflows/detect-setup-script.yml@main
    with:
      pattern: "**/*.iss"
      fail_if_missing: true

  build_installer:
    name: Build Windows Installer
    needs: [build_jar, detect_iss]
    uses:  m-nikolovska-mak-system/reusable-actions-library/.github/workflows/build-installer.yml@main
    with:
      setup_script: ${{ needs.detect_iss.outputs.setup_script }}
      jar_path: ${{ needs.build_jar.outputs.jar_path }}
      app_name: ${{ github.event.repository.name }}
      app_version: ${{ github.event.release.tag_name }}
      output_name: "Setup-${{ github.event.release.tag_name }}"

  upload_release:
    name: Upload Release Asset
    needs: build_installer
    uses: m-nikolovska-mak-system/reusable-actions-library/.github/workflows/upload-release.yml@main
    with:
      tag_name: ${{ github.event.release.tag_name }}
      artifact_path: ${{ needs.build_installer.outputs.installer_artifact_path }}
      # file_pattern: "*.exe"

  notify_failure:
    name: Notify on Failure
    needs: [build_jar, build_installer, upload_release]
    if: failure()
    uses:  m-nikolovska-mak-system/reusable-actions-library/.github/workflows/notify-teams.yml@main
