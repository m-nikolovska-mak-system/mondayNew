name: "Auto Generate and Update README"

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/**/*.yml"
      - ".github/workflows/**/*.yaml"


jobs:
  generate-readme:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout repository (no credentials)
      # -----------------------------
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # -----------------------------
      # 2. Create README if it doesn't exist
      # -----------------------------
      - name: Create README if missing
        run: |
          if [ ! -f README.md ]; then
            echo "# Project Documentation" > README.md
            echo "" >> README.md
            echo "This README is automatically generated by GitHub Actions." >> README.md
            echo "" >> README.md
            echo "<!-- MARKDOWN-AUTODOCS:START (code-block:src=.github/workflows/generate-readme.yml) -->" >> README.md
            echo "<!-- MARKDOWN-AUTODOCS:END -->" >> README.md
          fi

      # -----------------------------
      # 3. Run markdown-autodocs to update README
      # -----------------------------
      - name: Auto-update README with markdown-autodocs
        uses: dineshsonachalam/markdown-autodocs@v1.0.7
        with:
          commit_message: "docs: auto-update README"
          commit_author: GitHub Actions <actions@github.com>
          output_file_paths: |
            [
              "./README.md"
            ]
          categories: |
            [
              "code-block",
              "json-to-html-table",
              "workflow-artifact-table"
            ]

      # -----------------------------
      # 4. Configure Git
      # -----------------------------
      - name: Setup Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # -----------------------------
      # 5. Commit & push changes
      # -----------------------------
      - name: Push changes
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add README.md

          if git diff --cached --quiet; then
            echo "No changes â€” skipping commit."
            exit 0
          fi

          git commit -m "docs: auto-update README"
          git push "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}" HEAD:main
