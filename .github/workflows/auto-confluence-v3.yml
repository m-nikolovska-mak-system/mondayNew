name: Sync Docs to Confluence

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    # Prevent concurrent syncs
    concurrency:
      group: confluence-sync
      cancel-in-progress: false
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  
        
      - name: Detect changed files
        id: changed_files
        uses: tj-actions/changed-files@v44
        with:
          files: docs/**
          
  
      - name: Check if docs changed
        id: check_changes
        run: |
          if [ "${{ steps.changed_files.outputs.any_changed }}" == "true" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Docs changed!"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes in docs/"
          fi
      
      
      - name: List changed docs
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          echo "Changed docs files:"
          echo "${{ steps.changed_files.outputs.all_changed_files }}"
      
      
      - name: Warn on renamed/moved files
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          if [ -n "${{ steps.changed_files.outputs.renamed_files }}" ]; then
            echo "::warning::Some files were renamed or moved. Confluence may create duplicates."
            echo "${{ steps.changed_files.outputs.renamed_files }}"
          fi
  
      
      - name: Verify docs folder exists
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          if [ ! -d "docs" ]; then
            echo "Error: docs/ folder not found"
            exit 1
          fi
          if [ -z "$(ls -A docs)" ]; then
            echo "Error: docs/ folder is empty"
            exit 1
          fi
      
      - name: Publish Docs to Confluence
        if: steps.check_changes.outputs.changed == 'true'
        uses: Bhacaz/docs-as-code-confluence@v3
        with:
          folder: docs
          username: ${{ secrets.CONFLUENCE_USER }}
          password: ${{ secrets.CONFLUENCE_API_TOKEN }}
          confluence-base-url: https://mihaelanikolovska183014.atlassian.net/wiki
          space-key: DS
          parent-page-id: 2785550
        timeout-minutes: 10


      - name: Notify success
        if: steps.check_changes.outputs.changed == 'true' && success()
        run: echo "::notice::Confluence sync completed successfully âœ…"

      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Confluence sync failed. Check the logs above for details."
          echo "::notice::You may need to manually sync docs to Confluence"
