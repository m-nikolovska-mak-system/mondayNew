name: "Detect File Change"
description: "Detect if a specific file or path changed since the previous tag"
inputs:
  watched_path:
    description: "File or directory to monitor for changes"
    required: false
    default: ''
outputs:
  found:
    description: "Whether a change was found"
  files:
    description: "List of changed files"

runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect changed files
      id: detect
      shell: bash
      run: |
        set -e
        echo "🔍 Detecting changed files..."
        AFTER="${{ github.event.release.tag_name || github.sha }}"
        WATCHED_PATH="${{ inputs.watched_path }}"

        git fetch --tags --quiet
        PREV_TAG=$(git tag --sort=-creatordate | grep -A1 "$AFTER" | tail -n1 || true)

        if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "$AFTER" ]; then
          echo "ℹ️ No previous tag found — treating as initial release."
          CHANGED=$(git ls-tree -r --name-only "$AFTER")
        else
          echo "🔁 Comparing changes between $PREV_TAG → $AFTER"
          CHANGED=$(git diff --name-only "$PREV_TAG" "$AFTER")
        fi

        if [ -z "$CHANGED" ]; then
          echo "⚠️ No changes found."
          echo "found=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        if [ -n "$WATCHED_PATH" ]; then
          if echo "$CHANGED" | grep -q "$WATCHED_PATH"; then
            echo "✅ $WATCHED_PATH changed!"
          else
            echo "ℹ️ $WATCHED_PATH not changed."
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi

        echo "found=true" >> $GITHUB_OUTPUT
        echo "files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
